
const lut: Map<number, number> = new Map([
    [19967, 4882911],
    [16715781, 12205619],
    [846088, 4300105],
    [16765440, 14989128],
    [16255113, 13456512],
    [652789, 6140338],
    [16736519, 13593897],
    [15831219, 15106985],
    [622108, 5866556],
    [13142831, 10977351],
    [8167935, 8824313],
    [10423557, 9517358],
    [4128674, 7389575],
    [16097792, 13403693],
    [12888575, 11311343],
    [754843, 4688543],
    [11861817, 9682996],
    [16738538, 13724862],
    [14216959, 11323618],
    [6856253, 7773002],
    [11552035, 10964534],
    [16759676, 14655326],
    [3438079, 5149392],
    [14514239, 13400391],
    [16755443, 14063573],
    [4866934, 5525888],
    [7813633, 8146224],
    [12053091, 10927475],
    [10423557, 9517358],
    [8304896, 9022016],
    [737011, 4617685],
    [16715781, 12205619],
    [846088, 4300105],
    [16755596, 15440252],
    [652789, 6140338],
    [16576164, 15520136],
    [622108, 5866556],
    [15831219, 15106985],
    [16255113, 13456512],
    [4128674, 7389575],
    [9508870, 8599079],
    [8167935, 8824313],
    [3963508, 5208436],
    [11552035, 10964534],
    [11861817, 9682996],
    [7813633, 8146224],
    [14216959, 11323618],
    [6856253, 7773002],
    [754843, 4688543],
    [16765440, 14989128],
    [9903176, 9254472],
    [4866934, 5525888],
    [7752266, 7228234],
    [5187204, 6640038],
    [19967, 4882911],
    [737011, 4617685],
    [846088, 4300105],
    [62949, 6542022],
    [6898162, 7430366],
    [9437076, 9030017],
    [1798191, 3894583],
    [8176383, 8430042],
    [10654975, 9077463],
    [754843, 4688543],
    [6856253, 7773002],
    [5187204, 6640038],
    [2896556, 4871861],
    [6908064, 6908829],
    [14216959, 11323618],
    [3438079, 5149392],
    [8304896, 9022016],
    [4866934, 5525888],
    [12053091, 10927475],
    [12888575, 11311343],
    [3633466, 4747072],
    [16715781, 12205619],
    [16765440, 14989128],
    [16736519, 13593897],
    [16255113, 13456512],
    [16576164, 15520136],
    [9054248, 8406081],
    [15831219, 15106985],
    [13142831, 10977351],
    [11552035, 10964534],
    [16759676, 14655326],
    [10703476, 9852530],
    [7813633, 8146224],
    [16097792, 13403693],
    [12296843, 11969165],
    [9903176, 9254472],
    [16738538, 13724862],
    [14514239, 13400391],
    [16755443, 14063573],
    [7752266, 7228234],
    [10423557, 9517358],
    [19967, 4882911],
    [652789, 6140338],
    [8167935, 8824313],
    [2896556, 4871861],
    [14216959, 11323618],
    [754843, 4688543],
    [3963647, 5346770],
    [6251666, 6317711],
    [16715781, 12205619],
    [16736519, 13593897],
    [16765440, 14989128],
    [16736344, 13527899],
    [16759676, 14655326],
    [13142831, 10977351],
    [16097792, 13403693],
    [10423557, 9517358],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [4128674, 7389575],
    [6856253, 7773002],
    [8304896, 9022016],
    [12053091, 10927475],
    [3633466, 4747072],
    [19967, 4882911],
    [8167935, 8824313],
    [14216959, 11323618],
    [652789, 6140338],
    [3438079, 5149392],
    [754843, 4688543],
    [16715781, 12205619],
    [16736519, 13593897],
    [16736344, 13527899],
    [11552035, 10964534],
    [16255113, 13456512],
    [9903176, 9254472],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [4128674, 7389575],
    [6856253, 7773002],
    [8304896, 9022016],
    [16765440, 14989128],
    [16097792, 13403693],
    [16576164, 15520136],
    [16759676, 14655326],
    [12296843, 11969165],
    [13142831, 10977351],
    [19967, 4882911],
    [8167935, 8824313],
    [14216959, 11323618],
    [652789, 6140338],
    [3438079, 5149392],
    [16715781, 12205619],
    [16736519, 13593897],
    [16736344, 13527899],
    [11552035, 10964534],
    [10423557, 9517358],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [4128674, 7389575],
    [6856253, 7773002],
    [16765440, 14989128],
    [16097792, 13403693],
    [16576164, 15520136],
    [16759676, 14655326],
    [13142831, 10977351],
    [16255113, 13456512],
    [16738538, 13724862],
    [16755443, 14063573],
    [11141266, 10566808],
    [7344482, 6826851],
    [19967, 4882911],
    [8167935, 8824313],
    [14216959, 11323618],
    [2896556, 4871861],
    [16715781, 12205619],
    [16736344, 13527899],
    [11552035, 10964534],
    [10423557, 9517358],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [4128674, 7389575],
    [16765440, 14989128],
    [16097792, 13403693],
    [16576164, 15520136],
    [10183688, 9528350],
    [16255113, 13456512],
    [16738538, 13724862],
    [16755443, 14063573],
    [9903176, 9254472],
    [16736519, 13593897],
    [16759676, 14655326],
    [14514239, 13400391],
    [7813633, 8146224],
    [19967, 4882911],
    [8167935, 8824313],
    [2896556, 4871861],
    [16715781, 12205619],
    [16736344, 13527899],
    [10423557, 9517358],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [16765440, 14989128],
    [16097792, 13403693],
    [16576164, 15520136],
    [16255113, 13456512],
    [16738538, 13724862],
    [16755443, 14063573],
    [16736519, 13593897],
    [16759676, 14655326],
    [14514239, 13400391],
    [652789, 6140338],
    [754843, 4688543],
    [14216959, 11323618],
    [19967, 4882911],
    [8167935, 8824313],
    [2896556, 4871861],
    [16715781, 12205619],
    [16736344, 13527899],
    [10423557, 9517358],
    [845848, 4300105],
    [11861817, 9682996],
    [622108, 5866556],
    [16765440, 14989128],
    [16097792, 13403693],
    [16576164, 15520136],
    [16255113, 13456512],
    [16738538, 13724862],
    [9903176, 9254472],
    [16736519, 13593897],
    [16759676, 14655326],
    [14514239, 13400391],
    [652789, 6140338],
    [754843, 4688543],
    [14216959, 11323618],
    [8859130, 9135587],
    [6818209, 7159967],
    [12888575, 11311343],
]);

export class Lut {

    public static inter(color: number): number {
        const cache: string | null = localStorage.getItem("gex.lut.cache");
        let json;
        if (cache == null) {
            localStorage.setItem("gex.lut.cache", "{}");
            json = JSON.parse("{}");
        } else {
            json = JSON.parse(cache);
            if (json[color]) {
                return json[color];
            }
        }

        let lutb64: string | null = localStorage.getItem("gex.lut");
        let img: HTMLImageElement = new Image();
        if (lutb64 == null) {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            img.onload = () => {
                canvas.height = img.height;
                canvas.width = img.width;
                ctx?.drawImage(img, 0, 0);
                lutb64 = canvas.toDataURL("image/png");
                localStorage.setItem("gex.lut", lutb64);
                console.log(`Lut> loaded lut!`);
            };

            img.src = "/img/lut.png";
            if (img.complete || img.complete === undefined) {
                img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
                img.src = "/img/lut.png";
            }
        }

        if (lutb64 == null) {
            return color;
        }

        img.src = lutb64;

        //console.log(`is Lut not null here? ${!!lutb64}`);

        const canvas = document.createElement("canvas");
        canvas.height = img.height;
        canvas.width = img.width;
        const ctx = canvas.getContext("2d");
        if (ctx == null) {
            return color;
        }

        ctx.drawImage(img, 0, 0);
        const lutData: ImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        const r = Math.floor(((color >> 16) & 0xFF) / 4);
        const g = Math.floor(((color >> 8) & 0xFF) / 4);
        const b = Math.floor(((color >> 0) & 0xFF) / 4);

        const lutX = (b % 8) * 64 + r;
        const lutY = Math.floor(b / 8) * 64 + g;
        const index = (lutY * canvas.width + lutX) * 4;

        if (index > lutData.data.length) {
            console.warn(`Lut> index of color was beyond the image index [color=${color}] [index=${index}]`);
        }

        const lr = lutData.data[index + 0];
        const lg = lutData.data[index + 1];
        const lb = lutData.data[index + 2];

        console.log(`rgb ${r},${g},${b} xy ${lutX},${lutY} index ${index} lrgb ${lr},${lg},${lb}`);

        const output: number = (lr << 16) | (lg << 8) | lb;
        json[color] = output;

        localStorage.setItem("gex.lut.cache", JSON.stringify(json));

        return output;

        /**
         * while most of this code has been re-written multiple times, i liked how this cube turned out, so it stays here :)
         *      c011---------c111
         *     /|           /|
         *    / |          / |
         *  c001-------c101  |
         *  |   |         |  |
         *  |   c010------|--c110
         *  |  /          | /
         *  | /           |/
         *  c000----------c100
         * 
         * this side is the front
         */

        /* TEST INPUT: these values will produce the input as the output (tested for 0x00 thru 0xFFFFFF)
        const c000 = 0x00_ff_ff; // front bottom left
        const c001 = 0x00_00_ff; // front top left
        const c010 = 0x00_ff_00; // back bottom left
        const c011 = 0x00_00_00; // back top left
        const c100 = 0xff_ff_ff; // front bottom right
        const c101 = 0xff_00_ff; // front top right
        const c110 = 0xff_ff_00; // back bottom right
        const c111 = 0xff_00_00; // back top right
        */

        /*
        const c000 = 0x58c0c3; // front bottom left
        const c001 = 0x3a46d1; // front top left
        const c010 = 0x08c435; // back bottom left
        const c011 = 0x594047; // back top left
        const c100 = 0xcec2cc; // front bottom right
        const c101 = 0xdb1dd8; // front top right
        const c110 = 0xd7c800; // back bottom right
        const c111 = 0xcc2a20; // back top right

        const r0 = ((c000 >> 16) & 0xFF);
        const g0 = ((c000 >> 8) & 0xFF);
        const b0 = ((c000 >> 0) & 0xFF);

        const r1 = ((c111 >> 16) & 0xFF);
        const g1 = ((c111 >> 8) & 0xFF);
        const b1 = ((c111 >> 0) & 0xFF);

        const r = ((color >> 16) & 0xFF);
        const g = ((color >> 8) & 0xFF);
        const b = ((color >> 0) & 0xFF);

        const rd = (r - r0) / (r1 - r0);
        const gd = (g - g0) / (g1 - g0);
        const bd = (b - b0) / (b1 - b0);

        const c00 = c000 * (1 - rd) + c100 * rd;
        const c01 = c001 * (1 - rd) + c101 * rd;
        const c10 = c010 * (1 - rd) + c110 * rd;
        const c11 = c011 * (1 - rd) + c111 * rd;

        const c0 = c00 * (1 - bd) + c10 * bd;
        const c1 = c01 * (1 - bd) + c11 * bd;

        return Math.round((c0 * (1 - gd)) + (c1 * gd));

        return c000 * (1 - rd)  * (1 - gd)  * (1 - bd)
            + c100 * rd         * (1 - gd)  * (1 - bd)
            + c010 * (1 - rd)   * gd        * (1 - bd)
            + c110 * rd         * gd        * (1 - bd)
            + c001 * (1 - rd)   * (1 - gd)  * bd
            + c101 * rd         * (1 - gd)  * bd
            + c011 * (1 - rd)   * gd        * bd
            + c111 * rd         * gd        * bd;
        */
    }

    public static lut(color: number): number {
        return lut.get(color) ?? color;
    }

}

(window as any).Lut = Lut;